<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cdnu.cgi.mapper.TeamMemberMapper">

    <!-- 团队成员基本信息结果映射 -->
    <resultMap id="TeamMemberResultMap" type="com.cdnu.cgi.entity.TeamMember">
        <id property="id" column="id"/>
        <result property="teamId" column="team_id"/>
        <result property="userId" column="user_id"/>
        <result property="role" column="role"/>
        <result property="joinedAt" column="joined_at"/>
        <result property="status" column="status"/>
    </resultMap>

    <!-- 团队成员详细信息结果映射 -->
    <resultMap id="TeamMemberDetailResultMap" type="com.cdnu.cgi.entity.TeamMemberDetailInfo">
        <result property="teamId" column="team_id"/>
        <result property="teamName" column="team_name"/>
        <result property="userId" column="user_id"/>
        <result property="role" column="role"/>
        <result property="joinedAt" column="joined_at"/>
        <result property="status" column="status"/>
        <result property="skills" column="skills"/>
        <result property="honours" column="honours"/>
        <result property="username" column="username"/>
        <result property="realName" column="real_name"/>
        <result property="email" column="email"/>
        <result property="major" column="major"/>
        <result property="avatarUrl" column="avatar_url"/>
    </resultMap>

    <!-- 根据团队ID查找成员 -->
    <select id="selectByTeamId" resultMap="TeamMemberResultMap">
        SELECT * FROM team_members WHERE team_id = #{teamId}
    </select>

    <!-- 根据用户ID查找团队成员记录 -->
    <select id="selectByUserId" resultMap="TeamMemberResultMap">
        SELECT * FROM team_members WHERE user_id = #{userId}
    </select>

    <!-- 根据团队ID和用户ID查找成员 -->
    <select id="selectByTeamIdAndUserId" resultMap="TeamMemberResultMap">
        SELECT * FROM team_members WHERE team_id = #{teamId} AND user_id = #{userId}
    </select>

    <!-- 根据团队ID和状态查找成员 -->
    <select id="selectByTeamIdAndStatus" resultMap="TeamMemberResultMap">
        SELECT * FROM team_members WHERE team_id = #{teamId} AND status = #{status}
    </select>

    <!-- 根据用户ID和状态查找团队成员记录 -->
    <select id="selectByUserIdAndStatus" resultMap="TeamMemberResultMap">
        SELECT * FROM team_members WHERE user_id = #{userId} AND status = #{status}
    </select>

    <!-- 统计团队活跃成员数量 -->
    <select id="countActiveTeamMembers" resultType="java.lang.Long">
        SELECT COUNT(*) FROM team_members WHERE team_id = #{teamId} AND status = 'active'
    </select>

    <!-- 检查用户是否已经是团队活跃成员 -->
    <select id="existsByTeamIdAndUserIdAndStatusActive" resultType="boolean">
        SELECT COUNT(*) > 0 FROM team_members 
        WHERE team_id = #{teamId} AND user_id = #{userId} AND status = 'active'
    </select>

    <!-- 检查用户是否已经是团队成员（简化版本） -->
    <select id="existsByTeamIdAndUserId" resultType="boolean">
        SELECT COUNT(*) > 0 FROM team_members 
        WHERE team_id = #{teamId} AND user_id = #{userId}
    </select>

    <!-- 查询所有团队成员 -->
    <select id="selectAll" resultMap="TeamMemberResultMap">
        SELECT * FROM team_members
    </select>

    <!-- 插入团队成员 -->
    <insert id="insert" parameterType="com.cdnu.cgi.entity.TeamMember" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO team_members (team_id, user_id, role, joined_at, status)
        VALUES (#{teamId}, #{userId}, #{role}, #{joinedAt}, #{status})
    </insert>

    <!-- 更新团队成员信息 -->
    <update id="updateById" parameterType="com.cdnu.cgi.entity.TeamMember">
        UPDATE team_members
        SET team_id = #{teamId}, user_id = #{userId}, role = #{role},
            joined_at = #{joinedAt}, status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 根据ID删除团队成员 -->
    <delete id="deleteById">
        DELETE FROM team_members WHERE id = #{id}
    </delete>

    <!-- 根据团队ID删除所有成员 -->
    <delete id="deleteByTeamId">
        DELETE FROM team_members WHERE team_id = #{teamId}
    </delete>

    <!-- 统计团队成员总数 -->
    <select id="count" resultType="long">
        SELECT COUNT(*) FROM team_members
    </select>

    <!-- 根据团队ID查询团队成员详细信息（包含技能和荣誉） -->
    <select id="selectTeamMemberDetailsByTeamId" resultMap="TeamMemberDetailResultMap">
        SELECT 
            tm.team_id,
            t.name AS team_name,
            tm.user_id,
            tm.role,
            tm.joined_at,
            tm.status,
            GROUP_CONCAT(DISTINCT us.skill ORDER BY us.skill ASC SEPARATOR ',') AS skills,
            GROUP_CONCAT(DISTINCT CONCAT(uh.honour_title,'(',DATE_FORMAT(uh.obtained_time,'%Y-%m-%d'),')',IFNULL(CONCAT('|',uh.certificate_image_url),'')) ORDER BY uh.obtained_time ASC SEPARATOR ',') AS honours,
            u.username,
            u.real_name,
            u.email,
            u.major,
            u.avatar_url
        FROM team_members tm
        JOIN teams t ON tm.team_id = t.id
        JOIN users u ON tm.user_id = u.id
        LEFT JOIN user_skills us ON tm.user_id = us.user_id
        LEFT JOIN user_honours uh ON tm.user_id = uh.user_id
        WHERE tm.team_id = #{teamId} AND tm.status = 'active'
        GROUP BY tm.team_id, t.name, tm.user_id, tm.role, tm.joined_at, tm.status, u.username, u.real_name, u.email, u.major, u.avatar_url
        ORDER BY tm.joined_at ASC
    </select>

    <!-- 根据团队ID和用户ID查询特定成员的详细信息 -->
    <select id="selectTeamMemberDetailByTeamIdAndUserId" resultMap="TeamMemberDetailResultMap">
        SELECT 
            tm.team_id,
            t.name AS team_name,
            tm.user_id,
            tm.role,
            tm.joined_at,
            tm.status,
            GROUP_CONCAT(DISTINCT us.skill ORDER BY us.skill ASC SEPARATOR ',') AS skills,
            GROUP_CONCAT(DISTINCT CONCAT(uh.honour_title,'(',DATE_FORMAT(uh.obtained_time,'%Y-%m-%d'),')',IFNULL(CONCAT('|',uh.certificate_image_url),'')) ORDER BY uh.obtained_time ASC SEPARATOR ',') AS honours,
            u.username,
            u.real_name,
            u.email,
            u.major,
            u.avatar_url
        FROM team_members tm
        JOIN teams t ON tm.team_id = t.id
        JOIN users u ON tm.user_id = u.id
        LEFT JOIN user_skills us ON tm.user_id = us.user_id
        LEFT JOIN user_honours uh ON tm.user_id = uh.user_id
        WHERE tm.team_id = #{teamId} AND tm.user_id = #{userId} AND tm.status = 'active'
        GROUP BY tm.team_id, t.name, tm.user_id, tm.role, tm.joined_at, tm.status, u.username, u.real_name, u.email, u.major, u.avatar_url
    </select>
</mapper>